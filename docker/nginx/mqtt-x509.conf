stream {
   include snippets/stream_access_log.conf;

    # Include JS script for mTLS
    js_include authorization.js;

    # Include single-node or multiple-node (cluster) upstream
    include snippets/mqtt-upstream.conf;
    ssl_verify_client on;
    include snippets/ssl-client.conf;

    server {
        listen ${MF_NGINX_MQTT_PORT};
        listen [::]:${MF_NGINX_MQTT_PORT};
        listen ${MF_NGINX_MQTTS_PORT} ssl;
        listen [::]:${MF_NGINX_MQTTS_PORT} ssl;

        include snippets/ssl.conf;
        js_preread authenticate;

        proxy_pass mqtt_cluster;
    }
}